name: reset

on:
  workflow_dispatch:
    inputs:
      run_get_users:
        description: 'Run: Fetch users from list-user DB'
        required: false
        default: true
        type: boolean
      run_reset_members:
        description: "Run: Reset 'Th√†nh vi√™n' property"
        required: false
        default: true
        type: boolean
      run_list_blocks:
        description: 'Run: List all blocks in main page'
        required: false
        default: true
        type: boolean
      run_clear_notifications:
        description: "Run: Clear children under heading 'Th√¥ng b√°o:'"
        required: false
        default: true
        type: boolean
      run_notify_users:
        description: "Run: Append notifications under heading 'Th√¥ng b√°o:'"
        required: false
        default: true
        type: boolean
      run_remind_members:
        description: "Run: Remind members who haven't voted this week"
        required: false
        default: true
        type: boolean
      page:
        description: 'Select target page (main or notification)'
        required: false
        type: choice
        default: 'main'
        options:
          - 'main'
          - 'notification'
  schedule:
    # 23:50 every Sunday Asia/Ho_Chi_Minh = 16:50 UTC Sunday
    - cron: '50 16 * * 0'
    # üïò 09:00 every Saturday Asia/Ho_Chi_Minh = 02:00 UTC Saturday
    - cron: '0 2 * * 6'

jobs:
  reset:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run reset script
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          DATABASE_ID: ${{ secrets.DATABASE_ID }}
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.run_get_users || true }}" = "true" ]; then ARGS="$ARGS --get-users"; fi
          if [ "${{ github.event.inputs.run_reset_members || true }}" = "true" ]; then ARGS="$ARGS --reset-members"; fi
          if [ "${{ github.event.inputs.run_list_blocks || true }}" = "true" ]; then ARGS="$ARGS --list-blocks"; fi
          if [ "${{ github.event.inputs.run_clear_notifications || true }}" = "true" ]; then ARGS="$ARGS --clear-notify"; fi
          if [ "${{ github.event.inputs.run_notify_users || true }}" = "true" ]; then ARGS="$ARGS --notify-users"; fi
          TARGET="${{ github.event.inputs.page || 'main' }}"
          if [ "$TARGET" = "main" ]; then
            ARGS="$ARGS --main-page-id env_default_main"
          else
            ARGS="$ARGS --notification-page-id env_default_notification"
          fi
          node bin/reset.js $ARGS

      - name: Run remindMember (check and notify unvoted members)
        if: ${{ github.event.inputs.run_remind_members == 'true' }}
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          DATABASE_ID: ${{ secrets.DATABASE_ID }}
        run: node src/services/remindMember.js
