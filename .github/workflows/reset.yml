# .github/workflows/reset.yml
name: reset

on:
  workflow_dispatch:
    inputs:
      run_get_users:
        description: 'Run: Fetch users from list-user DB'
        required: false
        default: 'true'
        type: choice
        options: ['true', 'false']
      run_reset_members:
        description: "Run: Reset 'Thành viên' property"
        required: false
        default: 'true'
        type: choice
        options: ['true', 'false']
      run_list_blocks:
        description: 'Run: List all blocks in main page'
        required: false
        default: 'true'
        type: choice
        options: ['true', 'false']
      run_clear_notifications:
        description: "Run: Clear children under heading 'Thông báo:'"
        required: false
        default: 'true'
        type: choice
        options: ['true', 'false']
      run_notify_users:
        description: "Run: Append notifications under heading 'Thông báo:'"
        required: false
        default: 'true'
        type: choice
        options: ['true', 'false']
  schedule:
    # 23:50 every Sunday Asia/Ho_Chi_Minh = 16:50 UTC Sunday
    - cron: '50 16 * * 0'

jobs:
  reset:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run reset script
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          DATABASE_ID: ${{ secrets.DATABASE_ID }}
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.run_get_users || 'true' }}" = "true" ]; then ARGS="$ARGS --get-users"; fi
          if [ "${{ github.event.inputs.run_reset_members || 'true' }}" = "true" ]; then ARGS="$ARGS --reset-members"; fi
          if [ "${{ github.event.inputs.run_list_blocks || 'true' }}" = "true" ]; then ARGS="$ARGS --list-blocks"; fi
          if [ "${{ github.event.inputs.run_clear_notifications || 'true' }}" = "true" ]; then ARGS="$ARGS --clear-notify"; fi
          if [ "${{ github.event.inputs.run_notify_users || 'true' }}" = "true" ]; then ARGS="$ARGS --notify-users"; fi
          node bin/reset.js $ARGS
